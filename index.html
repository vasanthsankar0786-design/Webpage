<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>E2E</title>
<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome for icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
        padding: 40px 0;
        background: linear-gradient(135deg, #ff9a9e, #fad0c4, #a18cd1);
    }
    .container {
        max-width: 1200px;
        background: rgba(255, 255, 255, 0.95);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 15px 40px rgba(0,0,0,0.25);
    }
    h2 {
        text-align: center;
        color: #4a148c;
        margin-bottom: 25px;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    
    /* Search and controls */
    .controls-section {
        background: rgba(255, 255, 255, 0.8);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
    }
    
    .search-box {
        max-width: 400px;
    }
    
    /* Table styling */
    table td {
        min-width: 120px;
        transition: all 0.3s;
        cursor: text;
    }
    table td:focus {
        outline: 2px solid #7b1fa2;
        background-color: #f3e5f5 !important;
        box-shadow: 0 0 10px rgba(123, 31, 162, 0.3);
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f3e5f5;
    }
    .table-hover tbody tr:hover {
        background-color: #e1bee7;
    }
    
    /* Row selection */
    .row-selected {
        background-color: #fff3cd !important;
        border: 2px solid #ffc107;
    }
    
    /* Button styling */
    .btn-container {
        text-align: center;
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
    }
    .btn-custom {
        font-weight: bold;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        color: white;
        transition: all 0.3s;
    }
    .btn-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .btn-success-custom {
        background: linear-gradient(to right, #43e97b, #38f9d7);
    }
    .btn-danger-custom {
        background: linear-gradient(to right, #f5576c, #f093fb);
    }
    .btn-warning-custom {
        background: linear-gradient(to right, #f093fb, #f5576c);
    }
    .btn-primary-custom {
        background: linear-gradient(to right, #667eea, #764ba2);
    }
    .btn-info-custom {
        background: linear-gradient(to right, #38f9d7, #43e97b);
    }
    
    /* Toast notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
    }
    
    /* Loading spinner */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    /* File upload styling */
    .file-upload {
        border: 2px dashed #667eea;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        background: rgba(102, 126, 234, 0.1);
        transition: all 0.3s;
    }
    .file-upload:hover {
        background: rgba(102, 126, 234, 0.2);
    }
    
    /* Statistics panel */
    .stats-panel {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
</style>
</head>
<body>
<div class="container">
    <h2><i class="fas fa-table"></i> E2E Timesheet</h2>
    
    <!-- Statistics Panel -->
    <div class="stats-panel" id="statsPanel" style="display: none;">
        <div class="row text-center">
            <div class="col-md-3">
                <h5><i class="fas fa-users"></i> Total Rows</h5>
                <span id="totalRows">0</span>
            </div>
            <div class="col-md-3">
                <h5><i class="fas fa-leaf"></i> Vegetarian</h5>
                <span id="vegCount">0</span>
            </div>
            <div class="col-md-3">
                <h5><i class="fas fa-drumstick-bite"></i> Non-Vegetarian</h5>
                <span id="nonVegCount">0</span>
            </div>
            <div class="col-md-3">
                <h5><i class="fas fa-edit"></i> Modified</h5>
                <span id="modifiedIndicator">No</span>
            </div>
        </div>
    </div>
    
    <!-- Controls Section -->
    <div class="controls-section">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="search-box">
                    <label class="form-label"><i class="fas fa-search"></i> Search Table:</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search employees, dates, or preferences..." onkeyup="searchTable()">
                </div>
            </div>
            <div class="col-md-6">
                <div class="file-upload">
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importCSV()">
                    <label for="csvFileInput" class="mb-0" style="cursor: pointer;">
                        <i class="fas fa-upload"></i> Click to Import CSV File
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Table Section -->
    <div class="table-responsive">
        <table id="dataTable" class="table table-bordered table-striped table-hover align-middle">
            <thead id="tableHead" class="table-dark"></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
    
    <!-- Action Buttons -->
    <div class="btn-container">
        <button class="btn btn-custom btn-success-custom" onclick="addRow()">
            <i class="fas fa-plus"></i> Add Row
        </button>
        <button class="btn btn-custom btn-danger-custom" onclick="deleteRow()">
            <i class="fas fa-trash"></i> Delete Selected
        </button>
        <button class="btn btn-custom btn-warning-custom" onclick="clearData()">
            <i class="fas fa-eraser"></i> Clear All Data
        </button>
        <button class="btn btn-custom btn-info-custom" onclick="exportCSV()">
            <i class="fas fa-download"></i> Export CSV
        </button>
        <button class="btn btn-custom btn-primary-custom" onclick="saveData()">
            <i class="fas fa-save"></i> Save Changes
        </button>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;"></div>
</div>

<!-- Toast Container -->
<div class="toast-container"></div>

<!-- Papa Parse for proper CSV handling -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let selectedRow = null;
let originalData = [];
let isModified = false;
let autoSaveTimeout = null;

// Initialize the application
window.onload = function() {
    loadData();
    setupEventListeners();
};

function setupEventListeners() {
    // Auto-save on edit
    document.addEventListener('input', function(e) {
        if (e.target.contentEditable === 'true') {
            markAsModified();
            // Auto-save after 3 seconds of inactivity
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(autoSave, 3000);
        }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 's':
                    e.preventDefault();
                    saveData();
                    break;
                case 'n':
                    e.preventDefault();
                    addRow();
                    break;
                case 'Delete':
                case 'Backspace':
                    if (selectedRow) {
                        e.preventDefault();
                        deleteRow();
                    }
                    break;
            }
        }
    });
}

async function loadData() {
    showLoading(true);
    try {
        const res = await fetch("/get-data");
        const data = await res.json();
        originalData = JSON.parse(JSON.stringify(data)); // Deep copy
        
        renderTable(data);
        updateStatistics();
        showToast('Data loaded successfully!', 'success');
    } catch (error) {
        showToast('Error loading data: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function renderTable(data) {
    const tableHead = document.getElementById("tableHead");
    const tableBody = document.getElementById("tableBody");
    tableHead.innerHTML = "";
    tableBody.innerHTML = "";
    
    if (!data || data.length === 0) {
        handleEmptyDataset();
        return;
    }

    // Header with sorting
    const headerRow = document.createElement("tr");
    Object.keys(data[0]).forEach((col, index) => {
        const th = document.createElement("th");
        th.innerHTML = `<i class="fas fa-sort"></i> ${col}`;
        th.style.cursor = 'pointer';
        th.onclick = () => sortTable(index);
        th.title = 'Click to sort';
        headerRow.appendChild(th);
    });
    tableHead.appendChild(headerRow);

    // Body with row selection
    data.forEach((row, rowIndex) => {
        const tr = document.createElement("tr");
        tr.onclick = () => selectRow(tr);
        tr.style.cursor = 'pointer';
        
        Object.values(row).forEach((val) => {
            const td = document.createElement("td");
            td.contentEditable = true;
            td.innerText = val || '';
            td.onblur = () => updateStatistics();
            tr.appendChild(td);
        });
        tableBody.appendChild(tr);
    });
}

function selectRow(tr) {
    // Remove selection from other rows
    document.querySelectorAll('tbody tr').forEach(row => {
        row.classList.remove('row-selected');
    });
    
    // Select current row
    selectedRow = tr;
    tr.classList.add('row-selected');
}

function addRow() {
    const table = document.getElementById("dataTable");
    const headers = Array.from(table.querySelectorAll("th")).map(th => th.innerText.replace('ðŸ”½ ', '').replace('ðŸ”¼ ', '').replace(' ', '').trim());
    
    const tr = document.createElement("tr");
    tr.onclick = () => selectRow(tr);
    tr.style.cursor = 'pointer';
    
    headers.forEach(() => {
        const td = document.createElement("td");
        td.contentEditable = true;
        td.innerText = "";
        td.onblur = () => updateStatistics();
        tr.appendChild(td);
    });
    
    document.getElementById("tableBody").appendChild(tr);
    
    // Auto-select and focus the new row
    selectRow(tr);
    tr.firstChild.focus();
    
    markAsModified();
    updateStatistics();
    showToast('New row added!', 'success');
}

function deleteRow() {
    if (!selectedRow) {
        showToast('Please select a row to delete!', 'warning');
        return;
    }
    
    if (confirm('Are you sure you want to delete this row?')) {
        selectedRow.remove();
        selectedRow = null;
        markAsModified();
        updateStatistics();
        showToast('Row deleted successfully!', 'success');
    }
}

function clearData() {
    if (confirm('Are you sure you want to clear all data? This will empty all cells but keep the headers.')) {
        const tableBody = document.getElementById("tableBody");
        const rows = tableBody.querySelectorAll("tr");
        
        rows.forEach(row => {
            const cells = row.querySelectorAll("td");
            cells.forEach(cell => {
                cell.innerText = "";
            });
        });
        
        markAsModified();
        updateStatistics();
        showToast('All data cleared!', 'success');
    }
}

function searchTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const tableBody = document.getElementById('tableBody');
    const rows = tableBody.querySelectorAll('tr');
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        let found = false;
        
        cells.forEach(cell => {
            if (cell.innerText.toLowerCase().includes(searchTerm)) {
                found = true;
            }
        });
        
        row.style.display = found ? '' : 'none';
    });
}

function sortTable(columnIndex) {
    const table = document.getElementById('dataTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Toggle sort direction
    const th = table.querySelectorAll('th')[columnIndex];
    const isAscending = !th.classList.contains('desc');
    
    // Reset all headers
    table.querySelectorAll('th').forEach(header => {
        header.classList.remove('asc', 'desc');
        header.innerHTML = header.innerHTML.replace('ðŸ”¼ ', '').replace('ðŸ”½ ', '');
    });
    
    // Set current header
    th.classList.add(isAscending ? 'asc' : 'desc');
    const icon = isAscending ? 'ðŸ”¼ ' : 'ðŸ”½ ';
    th.innerHTML = icon + th.innerHTML;
    
    // Sort rows
    rows.sort((a, b) => {
        const aValue = a.children[columnIndex].innerText;
        const bValue = b.children[columnIndex].innerText;
        
        if (isAscending) {
            return aValue.localeCompare(bValue);
        } else {
            return bValue.localeCompare(aValue);
        }
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}

function updateStatistics() {
    const tableBody = document.getElementById('tableBody');
    const rows = tableBody.querySelectorAll('tr');
    let vegCount = 0;
    let nonVegCount = 0;
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        cells.forEach(cell => {
            const text = cell.innerText.toLowerCase();
            if (text.includes('veg') && !text.includes('non')) {
                vegCount++;
            } else if (text.includes('non-veg')) {
                nonVegCount++;
            }
        });
    });
    
    document.getElementById('totalRows').textContent = rows.length;
    document.getElementById('vegCount').textContent = vegCount;
    document.getElementById('nonVegCount').textContent = nonVegCount;
    document.getElementById('modifiedIndicator').textContent = isModified ? 'Yes' : 'No';
    document.getElementById('statsPanel').style.display = 'block';
}

function markAsModified() {
    isModified = true;
    updateStatistics();
}

async function autoSave() {
    if (isModified) {
        await saveData(true); // Silent save
    }
}

async function saveData(silent = false) {
    if (!silent) showLoading(true);
    
    try {
        const table = document.getElementById("dataTable");
        const headers = Array.from(table.querySelectorAll("th")).map(th => 
            th.innerText.replace('ðŸ”½ ', '').replace('ðŸ”¼ ', '').trim()
        );
        
        // Filter out the "No data available" placeholder row
        const visibleRows = Array.from(table.querySelectorAll("tbody tr")).filter(tr => {
            const firstCell = tr.querySelector('td');
            return firstCell && !firstCell.textContent.includes('No data available');
        });
        
        const data = visibleRows.map(tr => {
            const row = {};
            Array.from(tr.querySelectorAll("td")).forEach((td, i) => {
                // Save raw data without neutralization to preserve data integrity
                row[headers[i]] = td.innerText;
            });
            return row;
        });

        const res = await fetch("/save-data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        if (!res.ok) {
            throw new Error(`Server error: ${res.status} ${res.statusText}`);
        }

        const result = await res.json();
        if (result.status === "success") {
            isModified = false;
            updateStatistics();
            if (!silent) showToast('CSV saved successfully!', 'success');
        } else {
            throw new Error(result.message || 'Save failed');
        }
    } catch (error) {
        showToast('Error saving data: ' + error.message, 'error');
        console.error('Save error:', error);
    } finally {
        if (!silent) showLoading(false);
    }
}

function exportCSV() {
    const table = document.getElementById("dataTable");
    const headers = Array.from(table.querySelectorAll("th")).map(th => 
        th.innerText.replace('ðŸ”½ ', '').replace('ðŸ”¼ ', '').trim()
    );
    
    const rows = Array.from(table.querySelectorAll("tbody tr")).map(tr => {
        return Array.from(tr.querySelectorAll("td")).map(td => sanitizeForCSV(td.innerText));
    });
    
    // Use Papa Parse for proper CSV generation
    const csvContent = Papa.unparse({
        fields: headers,
        data: rows
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `csv_export_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    showToast('CSV exported successfully!', 'success');
}

function importCSV() {
    const fileInput = document.getElementById('csvFileInput');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    if (!file.name.toLowerCase().endsWith('.csv')) {
        showToast('Please select a valid CSV file!', 'warning');
        fileInput.value = '';
        return;
    }
    
    if (!confirm('This will replace all current data. Continue?')) {
        fileInput.value = '';
        return;
    }
    
    showLoading(true);
    
    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        transformHeader: function(header) {
            return header.trim();
        },
        transform: function(value) {
            // Clean up any neutralization from exported CSV files for data integrity
            return deNeutralizeData(value);
        },
        complete: function(results) {
            try {
                if (results.errors.length > 0) {
                    console.warn('CSV parsing warnings:', results.errors);
                }
                
                if (!results.data || results.data.length === 0) {
                    throw new Error('CSV file appears to be empty or contains no valid data');
                }
                
                // Validate that we have proper headers
                const headers = Object.keys(results.data[0]);
                if (headers.length === 0 || headers.every(h => !h || h.trim() === '')) {
                    throw new Error('CSV file must have valid column headers');
                }
                
                renderTable(results.data);
                markAsModified();
                updateStatistics();
                showToast(`CSV imported successfully! ${results.data.length} rows loaded.`, 'success');
            } catch (error) {
                showToast('Error importing CSV: ' + error.message, 'error');
            } finally {
                showLoading(false);
                fileInput.value = '';
            }
        },
        error: function(error) {
            showToast('Error reading CSV file: ' + error.message, 'error');
            showLoading(false);
            fileInput.value = '';
        }
    });
}

function showLoading(show) {
    document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container');
    const toastId = 'toast-' + Date.now();
    
    const bgClass = {
        'success': 'bg-success',
        'error': 'bg-danger',
        'warning': 'bg-warning',
        'info': 'bg-info'
    }[type] || 'bg-info';
    
    const icon = {
        'success': 'fas fa-check-circle',
        'error': 'fas fa-exclamation-circle',
        'warning': 'fas fa-exclamation-triangle',
        'info': 'fas fa-info-circle'
    }[type] || 'fas fa-info-circle';
    
    const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="${icon}"></i> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
    toast.show();
    
    // Remove from DOM after hiding
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

// Security: Sanitize data to prevent CSV injection attacks
function sanitizeForCSV(value) {
    if (typeof value !== 'string') {
        value = String(value);
    }
    
    // Prevent CSV injection by neutralizing formulas and control characters
    if (value.match(/^[=+\-@\t\r]/)) {
        value = "'" + value; // Prefix with single quote to neutralize
    }
    
    return value;
}

// Sanitize data when importing from CSV
function deNeutralizeData(value) {
    if (typeof value !== 'string') {
        return value;
    }
    
    // Remove any existing single quote prefix that was added for safety
    if (value.startsWith("'") && value.length > 1 && value.charAt(1).match(/[=+\-@\t\r]/)) {
        return value.substring(1);
    }
    
    return value;
}

// Enhanced error handling for empty datasets
function handleEmptyDataset() {
    const tableHead = document.getElementById("tableHead");
    const tableBody = document.getElementById("tableBody");
    
    // Provide default headers if none exist
    if (tableHead.children.length === 0) {
        const defaultHeaders = ['Employee Name', 'Column 1', 'Column 2', 'Column 3'];
        const headerRow = document.createElement("tr");
        
        defaultHeaders.forEach((header, index) => {
            const th = document.createElement("th");
            th.innerHTML = `<i class="fas fa-sort"></i> ${header}`;
            th.style.cursor = 'pointer';
            th.onclick = () => sortTable(index);
            th.title = 'Click to sort';
            headerRow.appendChild(th);
        });
        
        tableHead.appendChild(headerRow);
    }
    
    if (tableBody.children.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="100%" class="text-center text-muted">No data available. Click "Add Row" to start adding data.</td></tr>';
    }
}
</script>
</body>
</html>
